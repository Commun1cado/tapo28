<!DOCTYPE html>
<html>
<head>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body { 
  margin:0; padding:0; 
  background:url('tarot-bg.jpg') center/cover fixed no-repeat; 
  font-family:system-ui; 
  display:flex; flex-direction:column; 
  align-items:center; justify-content:center; 
  height: 100vh;
  width: 100vw;
  overflow: hidden;
  box-sizing: border-box;
}

.main-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
}

.title {
  font-size: 24px;
  font-weight: bold;
  color: #000;
  text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
  margin-bottom: 15px;
  transition: opacity 0.5s ease;
  flex-shrink: 0;
  z-index: 10;
}

.final-title {
  font-size: 24px;
  font-weight: bold;
  color: #000;
  text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -140px) translateZ(200px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 1s ease 0.5s;
  z-index: 9999;
  white-space: nowrap;
}

.grid { 
  display: grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap: 10px;
  width: 90vw;
  max-width: 360px;
  aspect-ratio: 3 / 4.8; 
  flex-shrink: 1;
}

.card-container {
  perspective: 1000px;
  width: 100%;
  height: 100%;
  position: relative;
  transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
}

.card {
  width: 100%;
  height: 100%;
  position: relative;
  transition: transform 0.6s;
  transform-style: preserve-3d;
  cursor: pointer;
}
.card.flipped { transform: rotateY(180deg); }

.card-front, .card-back {
  position: absolute;
  width: 100%;
  height: 100%;
  backface-visibility: hidden;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  background-repeat: no-repeat;
  background-position: center;
}

.card-front {
  background-image: url('cards/card-back.jpg');
  background-color: #2a1a4a;
  background-size: 100% 100%; 
}

.card-back {
  background-color: #1a1a1a;
  transform: rotateY(180deg);
  box-shadow: inset 0 0 10px rgba(0,0,0,0.4);
  background-size: 96% 96%; 
}

@keyframes zoomToCenter {
  0% { transform:scale(1); z-index:1000; }
  50% { transform:scale(1.5); z-index:1000; }
  100% { transform:scale(2.2) translateY(var(--centerOffsetY, 0)) translateX(var(--centerOffsetX, 0)); z-index:1000; }
}
@keyframes moveBack {
  0% { transform:scale(2.2) translateY(var(--centerOffsetY, 0)) translateX(var(--centerOffsetX, 0)); z-index:1000; }
  100% { transform:scale(1) translateY(0) translateX(0); z-index:1; }
}
.card-container.animate-zoom { animation:zoomToCenter 0.8s ease-out forwards; }
.card-container.animate-back { animation:moveBack 0.6s ease-in forwards; }

.fade-out {
  opacity: 0;
  transform: scale(0.8);
  pointer-events: none;
}

.final-placeholder {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  gap: 10px;
  pointer-events: none;
  opacity: 0;
}
.final-placeholder-item {
  width: 115px;
  height: 195px;
}

.decode-button {
  position: fixed;
  bottom: 140px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: url('tarot-bg.jpg') center/cover;
  color: #000;
  border: 2px solid rgba(255,255,255,0.5);
  border-radius: 25px;
  padding: 16px 40px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  opacity: 0;
  pointer-events: none;
  transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  z-index: 10000;
  white-space: nowrap;
  text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
}

.decode-button.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
  pointer-events: all;
}

.decode-button:active {
  transform: translateX(-50%) translateY(2px) scale(0.98);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

@media (max-height: 700px) {
  .grid {
    width: auto;
    height: 75vh;
    aspect-ratio: 3 / 4.8;
  }
}

@media (min-width: 600px) {
  .decode-button { bottom: 120px; }  /* <-- –î–ª—è Mac Telegram Desktop */
}

@media (min-width: 600px) and (min-height: 800px) {
  .grid { max-width: 400px; gap: 15px; }
  .final-placeholder-item { width: 130px; height: 215px; }
  .title, .final-title { font-size: 32px; }
  .final-title { transform: translate(-50%, -160px) translateZ(200px); }
  .decode-button { font-size: 20px; padding: 18px 50px; }
}

.disabled { pointer-events: none; }
</style>
</head>

<body>

<div class="main-wrapper">
  <div class="title">–í—ã–±–µ—Ä–∏—Ç–µ 3 –∫–∞—Ä—Ç—ã</div>
  <div class="final-title">–ö–∞—Ä—Ç—ã –≤—ã–±—Ä–∞–Ω—ã</div>
  <div class="grid" id="grid"></div>
</div>

<div class="final-placeholder" id="finalPlaceholder">
  <div class="final-placeholder-item"></div>
  <div class="final-placeholder-item"></div>
  <div class="final-placeholder-item"></div>
</div>

<button class="decode-button" id="decodeButton">üîÆ –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É</button>

<script>
const allCards = [
  'cards/00-TheFool.jpg', 'cards/01-TheMagician.jpg', 'cards/02-TheHighPriestess.jpg',
  'cards/03-TheEmpress.jpg', 'cards/04-TheEmperor.jpg', 'cards/05-TheHierophant.jpg',
  'cards/06-TheLovers.jpg', 'cards/07-TheChariot.jpg', 'cards/08-Strength.jpg',
  'cards/09-TheHermit.jpg', 'cards/10-WheelOfFortune.jpg', 'cards/11-Justice.jpg',
  'cards/12-TheHangedMan.jpg', 'cards/13-Death.jpg', 'cards/14-Temperance.jpg',
  'cards/15-TheDevil.jpg', 'cards/16-TheTower.jpg', 'cards/17-TheStar.jpg',
  'cards/18-TheMoon.jpg', 'cards/19-TheSun.jpg', 'cards/20-Judgement.jpg',
  'cards/21-TheWorld.jpg',
  'cards/Cups01.jpg', 'cards/Cups02.jpg', 'cards/Cups03.jpg', 'cards/Cups04.jpg',
  'cards/Cups05.jpg', 'cards/Cups06.jpg', 'cards/Cups07.jpg', 'cards/Cups08.jpg',
  'cards/Cups09.jpg', 'cards/Cups10.jpg', 'cards/Cups11.jpg', 'cards/Cups12.jpg',
  'cards/Cups13.jpg', 'cards/Cups14.jpg',
  'cards/Pentacles01.jpg', 'cards/Pentacles02.jpg', 'cards/Pentacles03.jpg', 'cards/Pentacles04.jpg',
  'cards/Pentacles05.jpg', 'cards/Pentacles06.jpg', 'cards/Pentacles07.jpg', 'cards/Pentacles08.jpg',
  'cards/Pentacles09.jpg', 'cards/Pentacles10.jpg', 'cards/Pentacles11.jpg', 'cards/Pentacles12.jpg',
  'cards/Pentacles13.jpg', 'cards/Pentacles14.jpg',
  'cards/Swords01.jpg', 'cards/Swords02.jpg', 'cards/Swords03.jpg', 'cards/Swords04.jpg',
  'cards/Swords05.jpg', 'cards/Swords06.jpg', 'cards/Swords07.jpg', 'cards/Swords08.jpg',
  'cards/Swords09.jpg', 'cards/Swords10.jpg', 'cards/Swords11.jpg', 'cards/Swords12.jpg',
  'cards/Swords13.jpg', 'cards/Swords14.jpg',
  'cards/Wands01.jpg', 'cards/Wands02.jpg', 'cards/Wands03.jpg', 'cards/Wands04.jpg',
  'cards/Wands05.jpg', 'cards/Wands06.jpg', 'cards/Wands07.jpg', 'cards/Wands08.jpg',
  'cards/Wands09.jpg', 'cards/Wands10.jpg', 'cards/Wands11.jpg', 'cards/Wands12.jpg',
  'cards/Wands13.jpg', 'cards/Wands14.jpg'
];

const grid = document.getElementById('grid');
const finalPlaceholder = document.getElementById('finalPlaceholder');
const decodeButton = document.getElementById('decodeButton');
const containers = [];
let selectedCount = 0;
let selectedIndices = [];
let selectedCards = [];

for (let i = 0; i < 9; i++) {
  const container = document.createElement('div');
  container.className = 'card-container';
  container.id = `card-${i}`;

  const card = document.createElement('div');
  card.className = 'card';

  const front = document.createElement('div');
  front.className = 'card-front';

  const back = document.createElement('div');
  back.className = 'card-back';

  card.appendChild(front);
  card.appendChild(back);
  container.appendChild(card);

  containers.push(container);
  container.onclick = () => flipCard(card, container, i);
  grid.appendChild(container);
}

function getRandomCard() {
  return allCards[Math.floor(Math.random() * allCards.length)];
}

function calculateOffset(cardIndex, centerIndex = 4) {
  const centerContainer = containers[centerIndex];
  const cardContainer = containers[cardIndex];

  const centerRect = centerContainer.getBoundingClientRect();
  const cardRect = cardContainer.getBoundingClientRect();

  const offsetX = centerRect.left - cardRect.left;
  const offsetY = centerRect.top - cardRect.top;

  return { offsetX, offsetY };
}

function finalArrangement() {
  const oldTitle = document.querySelector('.title');
  oldTitle.style.opacity = '0';
  
  const newTitle = document.querySelector('.final-title');
  newTitle.style.opacity = '1';

  containers.forEach((container, index) => {
    if (!selectedIndices.includes(index)) {
      container.classList.add('fade-out');
    }
  });

  const viewportCenterX = window.innerWidth / 2;
  const viewportCenterY = window.innerHeight / 2;

  const finalCardWidth = window.innerWidth >= 600 ? 130 : 115;
  const finalCardHeight = window.innerWidth >= 600 ? 215 : 195;
  const gap = 10;

  const totalWidth = finalCardWidth * 3 + gap * 2;
  const startX = viewportCenterX - totalWidth / 2;

  // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å–¥–≤–∏–≥–∞–µ–º –∫–∞—Ä—Ç—ã –í–´–®–ï, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –Ω–∏–∂–µ
  const cardOffsetY = window.innerWidth >= 600 ? -60 : 0;

  selectedIndices.forEach((index, i) => {
    const container = containers[index];
    const rect = container.getBoundingClientRect();

    const targetCenterX = startX + finalCardWidth * i + gap * i + finalCardWidth / 2;
    const targetCenterY = viewportCenterY + cardOffsetY;

    const currentCenterX = rect.left + rect.width / 2;
    const currentCenterY = rect.top + rect.height / 2;

    const deltaX = targetCenterX - currentCenterX;
    const deltaY = targetCenterY - currentCenterY;
    
    const scaleX = finalCardWidth / rect.width;
    const scaleY = finalCardHeight / rect.height;

    container.style.zIndex = 2000 + i;
    container.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${scaleX}, ${scaleY})`;
  });

  setTimeout(() => {
    decodeButton.classList.add('show');
  }, 1000);
}

function flipCard(cardEl, containerEl, index) {
  if (cardEl.classList.contains('disabled')) return;
  if (selectedCount === 3) return;

  cardEl.classList.add('disabled');

  const randomCard = getRandomCard();
  const backEl = cardEl.querySelector('.card-back');
  backEl.style.backgroundImage = `url('${randomCard}')`;

  Telegram.WebApp.HapticFeedback.impactOccurred('heavy');

  setTimeout(() => cardEl.classList.add('flipped'), 300);

  setTimeout(() => {
    const offset = calculateOffset(index, 4);
    containerEl.style.setProperty('--centerOffsetX', `${offset.offsetX * 0.3}px`);
    containerEl.style.setProperty('--centerOffsetY', `${offset.offsetY * 0.3}px`);
    containerEl.classList.add('animate-zoom');
  }, 300);

  setTimeout(() => {
    containerEl.classList.remove('animate-zoom');
    containerEl.classList.add('animate-back');
  }, 1100);

  setTimeout(() => {
    containerEl.classList.remove('animate-back');
    cardEl.classList.remove('disabled');

    selectedCount++;
    selectedIndices.push(index);
    selectedCards.push(randomCard);

    if (selectedCount === 3) setTimeout(finalArrangement, 500);
  }, 1700);
}

decodeButton.addEventListener('click', () => {
  Telegram.WebApp.HapticFeedback.impactOccurred('medium');
  console.log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã:', selectedCards);
  // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π
  // window.location.href = 'decode.html?cards=' + selectedCards.join(',');
});

Telegram.WebApp.ready();
Telegram.WebApp.expand();

Telegram.WebApp.MainButton.text = 'üîÆ –ù–æ–≤–æ–µ –≥–∞–¥–∞–Ω–∏–µ';
Telegram.WebApp.MainButton.color = '#6a0dad';
Telegram.WebApp.MainButton.textColor = 'white';
Telegram.WebApp.MainButton.onClick(() => location.reload());
Telegram.WebApp.MainButton.show();
</script>
</body>
</html>
